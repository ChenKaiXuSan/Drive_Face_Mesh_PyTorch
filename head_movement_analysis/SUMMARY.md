# Head Movement Analysis - å®ç°æ€»ç»“

## ğŸ“¦ æ¨¡å—ç»“æ„

```
head_movement_analysis/
â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ–æ–‡ä»¶
â”œâ”€â”€ main.py                  # æ ¸å¿ƒåˆ†ææ¨¡å—ï¼ˆHeadPoseAnalyzerç±»ï¼‰
â”œâ”€â”€ export_to_csv.py         # CSVå¯¼å‡ºå·¥å…·
â”œâ”€â”€ visualize_angles.py      # å¯è§†åŒ–å·¥å…·
â”œâ”€â”€ test.py                  # åŠŸèƒ½æµ‹è¯•è„šæœ¬
â”œâ”€â”€ requirements.txt         # Pythonä¾èµ–
â”œâ”€â”€ README.md                # è¯¦ç»†æ–‡æ¡£
â””â”€â”€ QUICKSTART.md           # å¿«é€Ÿå¼€å§‹æŒ‡å—
```

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. HeadPoseAnalyzer ç±»

ä½äº `main.py` ä¸­ï¼Œæä¾›ä»¥ä¸‹ä¸»è¦æ–¹æ³•ï¼š

#### `load_fused_keypoints(npy_path)`
- **åŠŸèƒ½**: è¯»å–èåˆåçš„3Då…³é”®ç‚¹æ•°æ®
- **è¾“å…¥**: .npyæ–‡ä»¶è·¯å¾„
- **è¾“å‡º**: (70, 3) çš„numpyæ•°ç»„

#### `extract_head_keypoints(keypoints_3d)`
- **åŠŸèƒ½**: æå–å¤´éƒ¨ç›¸å…³çš„å…³é”®ç‚¹
- **è¾“å…¥**: (70, 3) çš„3Då…³é”®ç‚¹æ•°ç»„
- **è¾“å‡º**: åŒ…å«å¤´éƒ¨å…³é”®ç‚¹çš„å­—å…¸

#### `calculate_head_angles(head_kpts)`
- **åŠŸèƒ½**: è®¡ç®—ä¸‰ä¸ªè½¬åŠ¨è§’åº¦
- **è¾“å…¥**: å¤´éƒ¨å…³é”®ç‚¹å­—å…¸
- **è¾“å‡º**: (pitch, yaw, roll) ä¸‰ä¸ªè§’åº¦å€¼

#### `analyze_head_pose(npy_path)`
- **åŠŸèƒ½**: åˆ†æå•å¸§çš„å¤´éƒ¨å§¿æ€
- **è¾“å…¥**: èåˆåçš„.npyæ–‡ä»¶è·¯å¾„
- **è¾“å‡º**: {'pitch': float, 'yaw': float, 'roll': float}

#### `analyze_sequence(fused_dir, start_frame, end_frame)`
- **åŠŸèƒ½**: æ‰¹é‡åˆ†æåºåˆ—ä¸­çš„æ‰€æœ‰å¸§
- **è¾“å…¥**: ç›®å½•è·¯å¾„å’Œå¯é€‰çš„å¸§èŒƒå›´
- **è¾“å‡º**: {frame_idx: {'pitch': float, 'yaw': float, 'roll': float}}

## ğŸ¯ ä¸‰ä¸ªè§’åº¦çš„è®¡ç®—æ–¹æ³•

### Pitchï¼ˆä¿¯ä»°è§’ï¼‰
- **å®šä¹‰**: å¤´éƒ¨ä¸Šä¸‹ç‚¹å¤´çš„è§’åº¦
- **è®¡ç®—æ–¹æ³•**: ä½¿ç”¨é¼»å­å’Œé¢ˆéƒ¨è¿çº¿ä¸æ°´å¹³é¢çš„å¤¹è§’
- **å…¬å¼**: `arctan2(nose_neck_vec[y], horizontal_dist)`
- **æ­£å€¼**: æŠ¬å¤´ï¼ˆå‘ä¸Šçœ‹ï¼‰
- **è´Ÿå€¼**: ä½å¤´ï¼ˆå‘ä¸‹çœ‹ï¼‰

### Yawï¼ˆåèˆªè§’ï¼‰
- **å®šä¹‰**: å¤´éƒ¨å·¦å³è½¬å¤´çš„è§’åº¦
- **è®¡ç®—æ–¹æ³•**: ä½¿ç”¨çœ¼ç›ä¸­å¿ƒåˆ°é¼»å­çš„å‘é‡åœ¨æ°´å¹³é¢ä¸Šçš„æŠ•å½±
- **å…¬å¼**: `arctan2(face_forward[x], -face_forward[z])`
- **æ­£å€¼**: å‘å³è½¬
- **è´Ÿå€¼**: å‘å·¦è½¬

### Rollï¼ˆç¿»æ»šè§’ï¼‰
- **å®šä¹‰**: å¤´éƒ¨å·¦å³å€¾æ–œçš„è§’åº¦
- **è®¡ç®—æ–¹æ³•**: ä½¿ç”¨å·¦å³çœ¼ç›è¿çº¿ä¸æ°´å¹³é¢çš„å¤¹è§’
- **å…¬å¼**: `arctan2(eye_vec[y], eye_vec[x])`
- **æ­£å€¼**: å‘å³å€¾æ–œ
- **è´Ÿå€¼**: å‘å·¦å€¾æ–œ

## ğŸ”§ å·¥å…·è„šæœ¬

### 1. export_to_csv.py
**åŠŸèƒ½**: å°†åˆ†æç»“æœå¯¼å‡ºä¸ºCSVæ–‡ä»¶

**ä½¿ç”¨æ–¹æ³•**:
```bash
python export_to_csv.py \
  --input /path/to/fused_npz \
  --output results.csv \
  --start 619 \
  --end 1000
```

**è¾“å‡ºæ ¼å¼**:
```csv
frame_idx,pitch_deg,yaw_deg,roll_deg
619,-49.81,-2.14,177.84
620,-49.81,-2.01,177.05
```

### 2. visualize_angles.py
**åŠŸèƒ½**: å¯è§†åŒ–è§’åº¦å˜åŒ–æ›²çº¿å’Œ3Dè½¨è¿¹

**ä½¿ç”¨æ–¹æ³•**:
```bash
# æ—¶é—´åºåˆ—å›¾
python visualize_angles.py \
  --input /path/to/fused_npz \
  --output angles_plot.png \
  --mode time

# 3Dè½¨è¿¹å›¾
python visualize_angles.py \
  --input /path/to/fused_npz \
  --output angles_3d.png \
  --mode 3d

# åŒæ—¶ç”Ÿæˆä¸¤ç§å›¾
python visualize_angles.py \
  --input /path/to/fused_npz \
  --output angles.png \
  --mode both
```

### 3. test.py
**åŠŸèƒ½**: éªŒè¯æ¨¡å—åŠŸèƒ½

**ä½¿ç”¨æ–¹æ³•**:
```bash
python test.py
```

## ğŸ“Š ä½¿ç”¨çš„å…³é”®ç‚¹

åŸºäºMHR70æ ¼å¼ï¼Œä½¿ç”¨ä»¥ä¸‹å…³é”®ç‚¹ï¼š

| ç´¢å¼• | åç§° | ç”¨é€” |
|------|------|------|
| 0 | nose | é¼»å­ï¼Œç”¨äºè®¡ç®—å¤´éƒ¨æœå‘ |
| 1 | left-eye | å·¦çœ¼ï¼Œç”¨äºè®¡ç®—rollè§’ |
| 2 | right-eye | å³çœ¼ï¼Œç”¨äºè®¡ç®—rollè§’ |
| 3 | left-ear | å·¦è€³ï¼Œè¾…åŠ©è®¡ç®— |
| 4 | right-ear | å³è€³ï¼Œè¾…åŠ©è®¡ç®— |
| 5 | left-shoulder | å·¦è‚©ï¼Œå‚è€ƒç‚¹ |
| 6 | right-shoulder | å³è‚©ï¼Œå‚è€ƒç‚¹ |
| 69 | neck | é¢ˆéƒ¨ï¼Œç”¨äºè®¡ç®—pitchè§’ |

## ğŸ’¡ æŠ€æœ¯ç‰¹ç‚¹

1. **é²æ£’æ€§**: è‡ªåŠ¨æ£€æµ‹å’Œè·³è¿‡æ— æ•ˆå…³é”®ç‚¹ï¼ˆNaNã€æ— ç©·å¤§ï¼‰
2. **æ‰¹é‡å¤„ç†**: æ”¯æŒåºåˆ—æ‰¹é‡åˆ†æï¼Œè‡ªåŠ¨å¹¶è¡Œå¤„ç†
3. **çµæ´»æ€§**: å¯æŒ‡å®šå¸§èŒƒå›´ï¼Œæ”¯æŒéƒ¨åˆ†æ•°æ®åˆ†æ
4. **å¯è§†åŒ–**: æä¾›2Dæ—¶é—´åºåˆ—å›¾å’Œ3Dè½¨è¿¹å›¾
5. **æ˜“ç”¨æ€§**: æä¾›å‘½ä»¤è¡Œå·¥å…·å’ŒPython APIä¸¤ç§ä½¿ç”¨æ–¹å¼

## ğŸ“ˆ æ€§èƒ½

- å•å¸§åˆ†æ: ~8ms
- 11å¸§åºåˆ—åˆ†æ: ~40ms
- 82å¸§åºåˆ—åˆ†æ: ~460ms

æµ‹è¯•ç¯å¢ƒ: Ubuntu 22.04, Python 3.x

## âœ… æµ‹è¯•ç»“æœ

æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼š
- âœ“ å•å¸§åˆ†æ
- âœ“ åºåˆ—åˆ†æ
- âœ“ CSVå¯¼å‡º
- âœ“ å›¾è¡¨ç”Ÿæˆ
- âœ“ åŒ…å¯¼å…¥

ç¤ºä¾‹è¾“å‡ºï¼š
```
Frame 619: Pitch= -49.81Â°, Yaw=  -2.14Â°, Roll= 177.84Â°
Frame 620: Pitch= -49.81Â°, Yaw=  -2.01Â°, Roll= 177.05Â°
Frame 621: Pitch= -49.82Â°, Yaw=  -2.62Â°, Roll= 177.87Â°
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

```python
# å¯¼å…¥æ¨¡å—
from head_movement_analysis import HeadPoseAnalyzer

# åˆ›å»ºåˆ†æå™¨
analyzer = HeadPoseAnalyzer()

# åˆ†æå•å¸§
result = analyzer.analyze_head_pose("frame_000619_fused.npy")
print(f"Pitch: {result['pitch']:.2f}Â°")

# åˆ†æåºåˆ—
results = analyzer.analyze_sequence("fused_npz/", start_frame=619, end_frame=700)
```

## ğŸ“š æ–‡æ¡£

- **README.md**: å®Œæ•´çš„APIæ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜
- **QUICKSTART.md**: å¿«é€Ÿå¼€å§‹æŒ‡å—
- **æœ¬æ–‡æ¡£**: å®ç°æ€»ç»“å’ŒæŠ€æœ¯ç»†èŠ‚

## ğŸ‘¤ ä½œè€…ä¿¡æ¯

- **ä½œè€…**: Kaixu Chen
- **é‚®ç®±**: chenkaixusan@gmail.com
- **æœºæ„**: The University of Tsukuba
- **æ—¥æœŸ**: February 7, 2026

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-02-07)
- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… å®ç°æ ¸å¿ƒåˆ†æåŠŸèƒ½
- âœ… æ·»åŠ CSVå¯¼å‡ºå·¥å…·
- âœ… æ·»åŠ å¯è§†åŒ–å·¥å…·
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œæµ‹è¯•

## ğŸ”® æœªæ¥æ”¹è¿›

å¯èƒ½çš„æ”¹è¿›æ–¹å‘ï¼š
1. æ”¯æŒæ›´å¤šçš„å…³é”®ç‚¹æ ¼å¼
2. æ·»åŠ æ—¶é—´æ»¤æ³¢åŠŸèƒ½ï¼ˆå¹³æ»‘è§’åº¦å˜åŒ–ï¼‰
3. æ”¯æŒå®æ—¶åˆ†æ
4. æ·»åŠ æ›´å¤šç»Ÿè®¡åˆ†æåŠŸèƒ½
5. GPUåŠ é€Ÿæ‰¹é‡å¤„ç†
